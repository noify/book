<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>
<body>
<input id="file" type="file" value="上传" multiple/>
<ul id="name_list"></ul>
<script lang="javascript" src="./xlsx.full.min.js"></script>
<script>
var addEvent = (function (){
    if(window.attachEvent){
      return function (ele, event, func) {
        ele.attachEvent('on' + event, func)
      }
    }
    else{
      return function (ele, event, func, options) {
        ele.addEventListener(event, func, typeof options === 'undefined' ? false : options)
      }
    }
})()

Date.prototype.format  = function(fmt) {  
  var o = {   
    "M+" : this.getMonth()+1,                 //月份   
    "d+" : this.getDate(),                    //日   
    "h+" : this.getHours(),                   //小时   
    "m+" : this.getMinutes(),                 //分   
    "s+" : this.getSeconds(),                 //秒   
    "q+" : Math.floor((this.getMonth()+3)/3), //季度   
    "S"  : this.getMilliseconds()             //毫秒   
  };   
  if(/(y+)/.test(fmt))   
    fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));   
  for(var k in o)   
    if(new RegExp("("+ k +")").test(fmt))   
  fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));   
  return fmt;   
}

var fileEl = document.getElementById('file')
var nameListEl = document.getElementById('name_list')
var now = new Date().format('yyyyMMdd')
var nameList = [
`XDZJ${now}_1Call`,
`${now}_新旦重疾险_1Call`,
``,
`XDYW${now}_1Call`,
`${now}_新旦意外险_1Call`,
``,
`XDHXF${now}_1Call`,
`${now}_新旦华夏福_1Call`,
``,
`XDHXF${now}_POM`,
`${now}_新旦华夏福_POM`,
``,
`XDHXF${now}_WinBack`,
`${now}_新旦华夏福_WinBack`,
``,
`XDCQT${now}_1Call`,
`${now}_新旦常青藤_1Call`,
``,
`XDCQT${now}_WinBack`,
`${now}_新旦常青藤_WinBack`,
``,
`XDCQT${now}_POM`,
`${now}_新旦常青藤_POM`,
].map(function (name) {
  return `<li>${name}</li>`
})
nameListEl.innerHTML = nameList.join('')
addEvent(nameListEl, 'click', function (e) {
  var target = e.target
  if (target.nodeName.toLowerCase() === 'li') {
    copy(target)
  }
})
addEvent(fileEl, 'click', function (e) {
  if (e.target.value !== '') {
    e.target.value = ''
  }
})
addEvent(fileEl, 'change', function (e) {
  var files = e.target.files
  for (var i = 0; i < files.length; i++) {
      let file = files[i]
      let reader = new FileReader()
      reader.readAsArrayBuffer(file)
      reader.onload = function (e) {
        var workbook = XLSX.read(this.result, {type:"array"})
        var Sheets = workbook.Sheets
        for (var sheet in Sheets) {
          var sheetJson = XLSX.utils.sheet_to_json(Sheets[sheet])
          
          for (var i in sheetJson) {
            var sji = sheetJson[i]
            var assignList = [
              // 新旦
              {o: '生日', n: '年龄/出生日期'},
              {o: '手机号码', n: '手机号'},
              {o: '手机', n: '手机号'},
              {o: '下单日期', n: '登录时间'},
              {o: '省', n: '省份'},
              {o: '市', n: '城市'},
              {o: '证件号码', n: '身份证号'},
              // 爱保
              {o: '生日', n: '出生日期'},
              {o: '保额', n: '保险金额'},
            ]
            
            for (var i in assignList) {
              var al = assignList[i]
              var sn = sji[al.n]

              if(sn !== undefined) {
                sji[al.o] = sn
              }
            }

            if (sji.性别 === '男') {
              sji.性别 = 0
            } else if (sji.性别 === '女') {
              sji.性别 = 1
            }
            
            sji.分公司代码 = 62
            sji.年龄 = Math.round((new Date()-new Date(sji.生日))/1000/60/60/24/365)
          }
          Sheets[sheet] = XLSX.utils.json_to_sheet(sheetJson)
        }
        workbook.Sheets = Sheets
        XLSX.writeFile(workbook, file.name, { bookType: 'xlml', bookSST: true, type: 'base64'})
      }
  }
})
/**
 * 一键粘贴
 * @param  {String} id [需要粘贴的内容]
 * @param  {String} attr [需要 copy 的属性，默认是 innerText，主要用途例如赋值 a 标签上的 href 链接]
 *
 * range + selection
 *
 * 1.创建一个 range
 * 2.把内容放入 range
 * 3.把 range 放入 selection
 *
 * 注意：参数 attr 不能是自定义属性
 * 注意：对于 user-select: none 的元素无效
 * 注意：当 id 为 false 且 attr 不会空，会直接复制 attr 的内容
 */
 function copy (el, attr) {
    let target = null;

    if (attr) {
        target = document.createElement('div');
        target.id = 'tempTarget';
        target.style.opacity = '0';
        if (el) {
            let curNode = el;
            target.innerText = curNode[attr];
        } else {
            target.innerText = attr;
        }
        document.body.appendChild(target);
    } else {
        target = el;
    }

    try {
        let range = document.createRange();
        range.selectNode(target);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand('copy');
        window.getSelection().removeAllRanges();
        console.log('复制成功')
    } catch (e) {
        console.log('复制失败')
    }

    if (attr) {
        // remove temp target
        target.parentElement.removeChild(target);
    }
}

</script>
</body>
</html>